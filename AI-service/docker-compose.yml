version: '3.8'

services:
  # MQTT Broker
  mqtt_broker:
    image: eclipse-mosquitto:2.0
    container_name: ambient-mqtt-broker
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mqtt-broker/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - /var/lib/ambient-node/mqtt/data:/mosquitto/data
      - /var/lib/ambient-node/mqtt/log:/mosquitto/log
    networks:
      - ambient-network
    restart: unless-stopped

  # Fan Service
  fan_service:
    image: jiyuniverse/ambient-node-fan-service:arm64
    container_name: ambient-fan-service
    privileged: true
    devices:
      - /dev/ttyAMA0:/dev/ttyAMA0
    volumes:
      - /var/lib/ambient-node:/var/lib/ambient-node
    environment:
      - MQTT_BROKER=mqtt_broker
      - MQTT_PORT=1883
      - PYTHONUNBUFFERED=1
    networks:
      - ambient-network
    depends_on:
      - mqtt_broker
    restart: unless-stopped

  # DB Service
  db_service:
    image: jiyuniverse/ambient-node-db-service:arm64
    container_name: ambient-db-service
    volumes:
      - /var/lib/ambient-node:/var/lib/ambient-node
    environment:
      - MQTT_BROKER=mqtt_broker
      - MQTT_PORT=1883
      - DB_PATH=/var/lib/ambient-node/db.sqlite
    networks:
      - ambient-network
    depends_on:
      - mqtt_broker
    restart: unless-stopped

  # AI Service (새로 추가)
  ai_service:
    image: jiyuniverse/ambient-node-ai-service:arm64  # Docker Hub에 업로드한 이미지
    container_name: ambient-ai-service
    privileged: true  # 카메라 접근 권한
    network_mode: host  # rpicam-vid TCP 스트림을 위해 호스트 네트워크 사용
    volumes:
      - /var/lib/ambient-node:/var/lib/ambient-node  # 사용자 데이터 공유
    environment:
      - MQTT_BROKER=localhost  # host 네트워크 모드이므로 localhost
      - MQTT_PORT=1883
      - MODEL_PATH=/models/facenet.tflite
      - PYTHONUNBUFFERED=1
      - DISPLAY=:0  # 디스플레이 사용 시 (headless 모드면 불필요)
    devices:
      - /dev/video0:/dev/video0  # 카메라 장치
    depends_on:
      - mqtt_broker
    restart: unless-stopped
    command: ["python3", "ai_service.py", "--headless"]  # 헤드리스 모드 실행

networks:
  ambient-network:
    driver: bridge
